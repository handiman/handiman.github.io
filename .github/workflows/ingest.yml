name: Trigger CV Ingestion

on:
  push:
    branches:
      - gh-pages 

jobs:
  ingest-cv:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Read Markdown and escape for JSON
        id: read_cv
        run: |
          CONTENT=$(cat assets/henrik-becker.md | jq -Rs .)
          echo "markdown=$CONTENT" >> $GITHUB_OUTPUT

      - name: Post to ingestion server with Bearer token
        env:
          API_KEY: ${{ secrets.AZURE_OPENAI_APIKEY }}
        run: |
          curl -X POST https://henrikbecker.azurewebsites.net/ai/ingest \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $API_KEY" \
            -d '{
              "source": "gh-pages",
              "commit": "${{ github.sha }}",
              "markdown": ${{ steps.read_cv.outputs.markdown }}
            }'

